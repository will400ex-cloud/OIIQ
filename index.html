<div class="input-group">
                        <label for="startQuestion">Commencer à la question n° (optionnel)</label>
                        <input type="number" id="startQuestion" min="1" placeholder="Ex: 25">
                        <small style="color: #6c757d; font-size: 14px; margin-top: 5px; display: block;">
                            💡 Utile pour reprendre là où vous vous êtes arrêté
                        </small>
                    </div><!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionnaire OIIQ - Préparation Examen</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .hidden { display: none; }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .option-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .info-box {
            background: #d4edda;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #28a745;
            color: #155724;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #dc3545;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 30px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .question-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .theme-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .theme-badge.hors-sujet {
            background: linear-gradient(45deg, #dc3545, #c82333);
            animation: single-pulse 1.5s ease-out;
        }
        
        @keyframes single-pulse {
            0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
            50% { box-shadow: 0 0 0 8px rgba(220, 53, 69, 0.3); }
            100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
        }
        
        .question-box {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .question-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .answer-options {
            list-style: none;
            margin-bottom: 20px;
        }
        
        .answer-option {
            margin-bottom: 12px;
        }
        
        .answer-option input[type="radio"] {
            display: none;
        }
        
        .answer-option label {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .answer-option label:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .answer-option input[type="radio"]:checked + label {
            border-color: #667eea;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        
        .answer-option input[type="radio"]:disabled + label {
            background: #e9ecef;
            border-color: #dee2e6;
            cursor: not-allowed;
            opacity: 0.7;
        }
        
        .answer-option input[type="radio"]:disabled:checked + label {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }
        
        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid;
        }
        
        .feedback.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .feedback.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .panel {
                padding: 20px;
                margin-bottom: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .header p {
                font-size: 1.1em !important;
            }
            
            .options-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .option-card {
                padding: 15px;
            }
            
            .controls {
                justify-content: center;
                flex-direction: column;
                gap: 10px;
            }
            
            .btn {
                padding: 12px 25px;
                font-size: 14px;
                width: 100%;
                max-width: 300px;
            }
            
            .question-info {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .question-title {
                font-size: 1.1em;
            }
            
            .answer-option label {
                padding: 12px 15px;
                font-size: 15px;
            }
            
            .feedback {
                padding: 15px;
                margin-top: 15px;
            }
            
            .input-group input, .input-group select {
                padding: 10px;
                font-size: 16px;
            }
            
            .checkbox-item {
                margin-bottom: 8px;
            }
            
            .checkbox-item label {
                font-size: 14px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 5px;
            }
            
            .panel {
                padding: 15px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .question-box {
                padding: 20px;
            }
            
            .btn {
                padding: 10px 20px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header panel">
            <div style="text-align: center; margin-bottom: 20px;">
                <h1>📋 Questionnaire OIIQ</h1>
                <p style="font-size: 1.3em; color: #667eea; font-weight: 600;">Préparation à l'examen professionnel d'infirmière</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-top: 25px; border-left: 5px solid #667eea;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">🎯 À propos de ce questionnaire</h3>
                <p style="color: #495057; line-height: 1.7; margin-bottom: 15px;">
                    Cet outil interactif a été conçu pour vous aider à préparer efficacement l'examen professionnel de l'Ordre des infirmières et infirmiers du Québec (OIIQ). 
                    Il vous permet de tester vos connaissances dans différents domaines des soins infirmiers à travers des questions à choix multiples.
                </p>
                
                <h4 style="color: #2c3e50; margin: 20px 0 10px 0;">🔧 Comment utiliser ce questionnaire :</h4>
                <ul style="color: #495057; line-height: 1.6; margin-left: 20px;">
                    <li><strong>Chargement :</strong> Cliquez sur "Charger le questionnaire" pour lancer vos questions personnalisées</li>
                    <li><strong>Filtrage :</strong> Sélectionnez un thème spécifique ou gardez "Tous les thèmes" pour un test complet</li>
                    <li><strong>Options :</strong> Choisissez entre correction instantanée (feedback immédiat) ou correction finale</li>
                    <li><strong>Mélange :</strong> Activez le mélange des questions et/ou des réponses pour un entraînement plus varié</li>
                    <li><strong>Navigation :</strong> Utilisez les boutons ou les touches du clavier (flèches, 1-4/A-D) pour naviguer</li>
                    <li><strong>Résultats :</strong> Obtenez un score détaillé et une analyse par thème à la fin</li>
                </ul>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 10px; margin: 20px 0; border-left: 5px solid #ffc107;">
                    <h4 style="color: #856404; margin-bottom: 10px;">🔴 Questions "Hors sujet" :</h4>
                    <p style="color: #856404; margin: 0; line-height: 1.6;">
                        Les questions marquées <strong style="color: #dc3545;">"Hors sujet OIIQ"</strong> en rouge restent <strong>pertinentes pour votre formation</strong> 
                        et peuvent enrichir vos connaissances générales en soins infirmiers. Bien qu'elles ne soient <strong>pas prioritaires</strong> 
                        pour l'examen OIIQ, elles constituent un complément utile à votre préparation.
                    </p>
                </div>
                
                <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <p style="color: #0066cc; font-weight: 600; margin: 0;">
                        💡 <strong>Conseil :</strong> Pour une préparation optimale, alternez entre les modes de correction instantanée (pour apprendre) 
                        et finale (pour simuler les conditions d'examen réelles).
                    </p>
                </div>
            </div>
        </div>

        <!-- Configuration -->
        <div id="setupPanel" class="panel">
            <h2>Configuration du questionnaire</h2>
            
            <div class="input-group">
                <label for="csvUrl">URL du fichier CSV</label>
                <input type="text" id="csvUrl" value="./Questions_Septembre_2025.csv">
            </div>

            <div class="options-grid">
                <div class="option-card">
                    <h4>🎯 Mode de correction</h4>
                    <div class="checkbox-item">
                        <input type="radio" id="instantMode" name="correctionMode" value="instant" checked>
                        <label for="instantMode">Correction instantanée</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="radio" id="finalMode" name="correctionMode" value="final">
                        <label for="finalMode">Correction à la fin</label>
                    </div>
                </div>

                <div class="option-card">
                    <h4>🔀 Ordre des questions</h4>
                    <div class="checkbox-item">
                        <input type="checkbox" id="shuffleQuestions">
                        <label for="shuffleQuestions">Mélanger les questions</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="shuffleOptions">
                        <label for="shuffleOptions">Mélanger les réponses</label>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label for="themeSelect">Sélectionner un thème</label>
                <select id="themeSelect">
                    <option value="">Tous les thèmes</option>
                </select>
            </div>

            <div class="input-group">
                <label for="startQuestion">Commencer à la question n° (optionnel)</label>
                <input type="number" id="startQuestion" min="1" placeholder="Ex: 25 pour commencer à la question 25">
                <small style="color: #6c757d; font-size: 14px; margin-top: 5px; display: block;">
                    💡 Utile pour reprendre là où vous vous êtes arrêté lors de votre dernière session
                </small>
            </div>

            <div style="text-align: center;">
                <button class="btn" onclick="loadQuestions()">Charger le questionnaire</button>
            </div>
        </div>

        <!-- Quiz -->
        <div id="quizPanel" class="panel hidden">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div class="question-info">
                <span id="questionCounter">Question 1 sur 10</span>
                <span class="theme-badge" id="currentTheme">Général</span>
            </div>

            <div class="question-box">
                <div class="question-title" id="questionText"></div>
                <ul class="answer-options" id="answerOptions"></ul>
                <div id="feedbackArea"></div>
            </div>

            <div class="controls">
                <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" style="display: none;">← Précédent</button>
                <button class="btn" id="stopBtn" onclick="stopQuiz()" style="background: linear-gradient(45deg, #ffc107, #fd7e14); display: block;">🛑 Arrêter ici</button>
                <button class="btn" id="nextBtn" onclick="nextQuestion()" style="display: none;">Suivant →</button>
                <button class="btn" id="finishBtn" onclick="showResults()" style="display: none;">Terminer</button>
            </div>
        </div>

        <!-- Résultats -->
        <div id="resultsPanel" class="panel hidden">
            <h2 style="text-align: center; margin-bottom: 30px;">🎉 Résultats</h2>
            <div id="resultsContent"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="restart()">Recommencer</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let correctionMode = 'instant';
        let questionResults = [];

        // Utilitaires
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let currentValue = '';
                let insideQuotes = false;
                
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim());
                
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index]?.replace(/"/g, '') || '';
                    });
                    data.push(row);
                }
            }
            return data;
        }

        function updateThemeSelect(themes) {
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.innerHTML = '<option value="">Tous les thèmes</option>';
                themes.sort().forEach(theme => {
                    const option = document.createElement('option');
                    option.value = theme;
                    option.textContent = theme;
                    themeSelect.appendChild(option);
                });
                console.log('Thèmes mis à jour:', themes);
            }
        }

        // Chargement depuis CSV
        async function loadQuestions() {
            const csvUrl = document.getElementById('csvUrl').value.trim();
            
            if (!csvUrl) {
                alert('Veuillez saisir une URL');
                return;
            }

            try {
                document.getElementById('setupPanel').innerHTML = '<div class="loading">Chargement...</div>';
                
                console.log('Chargement depuis:', csvUrl);
                
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('CSV reçu, longueur:', csvText.length);
                
                const data = parseCSV(csvText);
                console.log('Données parsées:', data.length, 'lignes');
                
                if (data.length === 0) {
                    throw new Error('Aucune donnée trouvée');
                }

                // Traitement des données
                questions = data.map((row, index) => ({
                    id: row.id || (index + 1),
                    theme: row.theme || 'Général',
                    question: row.question,
                    option_a: row.option_a || '',
                    option_b: row.option_b || '',
                    option_c: row.option_c || '',
                    option_d: row.option_d || '',
                    correct_answer: row.correct_answer || 'A',
                    feedback_correct: row.feedback_correct || 'Bonne réponse!',
                    feedback_incorrect: row.feedback_incorrect || 'Réponse incorrecte.'
                })).filter(q => q.question && q.question.trim());

                if (questions.length === 0) {
                    throw new Error('Aucune question valide trouvée');
                }

                // Mise à jour des thèmes
                const themes = [...new Set(questions.map(q => q.theme))];
                updateThemeSelect(themes);
                
                // Mettre à jour l'interface pour indiquer le succès
                document.getElementById('setupPanel').innerHTML = `
                    <h2>Configuration du questionnaire</h2>
                    
                    <div class="input-group">
                        <label for="csvUrl">URL du fichier CSV</label>
                        <input type="text" id="csvUrl" value="${csvUrl}">
                    </div>
                    
                    <div class="info-box">
                        <strong>✅ Fichier CSV chargé avec succès!</strong><br>
                        ${questions.length} questions ont été chargées.<br>
                        Thèmes disponibles : ${themes.join(', ')}<br>
                        Vous pouvez maintenant sélectionner vos options et lancer le questionnaire.
                    </div>

                    <div class="options-grid">
                        <div class="option-card">
                            <h4>🎯 Mode de correction</h4>
                            <div class="checkbox-item">
                                <input type="radio" id="instantMode" name="correctionMode" value="instant" checked>
                                <label for="instantMode">Correction instantanée</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" id="finalMode" name="correctionMode" value="final">
                                <label for="finalMode">Correction à la fin</label>
                            </div>
                        </div>

                        <div class="option-card">
                            <h4>🔀 Ordre des questions</h4>
                            <div class="checkbox-item">
                                <input type="checkbox" id="shuffleQuestions">
                                <label for="shuffleQuestions">Mélanger les questions</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="shuffleOptions">
                                <label for="shuffleOptions">Mélanger les réponses</label>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="themeSelect">Sélectionner un thème</label>
                        <select id="themeSelect">
                            <option value="">Tous les thèmes</option>
                        </select>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn" onclick="initializeQuiz()">Lancer le questionnaire</button>
                        <button class="btn btn-secondary" onclick="location.reload()">Recharger un autre fichier</button>
                    </div>
                `;
                
                // Re-populer le sélecteur de thème
                updateThemeSelect(themes);
                
                console.log('Questions chargées:', questions.length);
                console.log('Thèmes disponibles:', themes);
                
            } catch (error) {
                console.error('Erreur de chargement:', error);
                document.getElementById('setupPanel').innerHTML = `
                    <div class="error">
                        <h3>Erreur de chargement</h3>
                        <p>${error.message}</p>
                        <p>Vérifiez que le fichier existe et est accessible.</p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="location.reload()">Réessayer</button>
                    </div>
                `;
            }
        }

        function initializeQuiz() {
            // Récupération des paramètres
            correctionMode = document.querySelector('input[name="correctionMode"]:checked')?.value || 'instant';
            const selectedTheme = document.getElementById('themeSelect')?.value || '';
            const startQuestionNumber = parseInt(document.getElementById('startQuestion')?.value) || 1;
            
            // Filtrage par thème
            let filteredQuestions = questions;
            if (selectedTheme) {
                filteredQuestions = questions.filter(q => q.theme === selectedTheme);
            }
            
            // Mélange des questions
            if (document.getElementById('shuffleQuestions')?.checked) {
                filteredQuestions = shuffleArray(filteredQuestions);
            }
            
            if (filteredQuestions.length === 0) {
                alert('Aucune question ne correspond aux critères sélectionnés');
                return;
            }
            
            // Vérifier si le numéro de départ est valide
            if (startQuestionNumber > filteredQuestions.length) {
                alert(`Le numéro de départ (${startQuestionNumber}) est supérieur au nombre total de questions (${filteredQuestions.length}). Le questionnaire commencera à la question 1.`);
                currentQuestionIndex = 0;
            } else if (startQuestionNumber > 1) {
                currentQuestionIndex = startQuestionNumber - 1; // -1 car l'index commence à 0
                console.log(`Démarrage à la question ${startQuestionNumber}`);
            } else {
                currentQuestionIndex = 0;
            }
            
            questions = filteredQuestions;
            userAnswers = new Array(questions.length).fill(null);
            questionResults = new Array(questions.length).fill(null);
            
            showQuizPanel();
            displayQuestion();
        }

        function showQuizPanel() {
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('quizPanel').classList.remove('hidden');
        }

        function displayQuestion() {
            const question = questions[currentQuestionIndex];
            if (!question) return;
            
            // Mise à jour des informations
            document.getElementById('questionCounter').textContent = 
                `Question ${currentQuestionIndex + 1} sur ${questions.length}`;
            
            // Mise à jour du thème avec style spécial pour "hors sujet"
            const currentTheme = document.getElementById('currentTheme');
            if (currentTheme) {
                currentTheme.textContent = question.theme;
                
                // Ajouter classe spéciale pour les thèmes "hors sujet"
                if (question.theme.toLowerCase().includes('hors sujet')) {
                    currentTheme.classList.add('hors-sujet');
                } else {
                    currentTheme.classList.remove('hors-sujet');
                }
            }
            
            // Barre de progression
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Question
            document.getElementById('questionText').textContent = question.question;
            
            // Options
            const optionsContainer = document.getElementById('answerOptions');
            optionsContainer.innerHTML = '';
            
            const options = [
                {value: 'A', text: question.option_a},
                {value: 'B', text: question.option_b},
                {value: 'C', text: question.option_c},
                {value: 'D', text: question.option_d}
            ];
            
            options.forEach(option => {
                if (option.text.trim()) {
                    const li = document.createElement('li');
                    li.className = 'answer-option';
                    li.innerHTML = `
                        <input type="radio" id="option${option.value}" name="answer" value="${option.value}">
                        <label for="option${option.value}">${option.value}. ${option.text}</label>
                    `;
                    optionsContainer.appendChild(li);
                }
            });
            
            // Restaurer réponse précédente
            if (userAnswers[currentQuestionIndex]) {
                const prevAnswer = document.getElementById(`option${userAnswers[currentQuestionIndex]}`);
                if (prevAnswer) prevAnswer.checked = true;
            }
            
            // Événements
            document.querySelectorAll('input[name="answer"]').forEach(input => {
                input.addEventListener('change', function() {
                    userAnswers[currentQuestionIndex] = this.value;
                    
                    if (correctionMode === 'instant') {
                        showFeedback(this.value === question.correct_answer, question);
                        
                        // Désactiver toutes les options après sélection en mode instantané
                        document.querySelectorAll('input[name="answer"]').forEach(radio => {
                            radio.disabled = true;
                        });
                    }
                    
                    updateButtons();
                });
            });
            
            // Reset feedback
            document.getElementById('feedbackArea').innerHTML = '';
            updateButtons();
        }

        function showFeedback(isCorrect, question) {
            const feedbackArea = document.getElementById('feedbackArea');
            const feedbackClass = isCorrect ? 'correct' : 'incorrect';
            const feedbackTitle = isCorrect ? '✅ Correct!' : '❌ Incorrect';
            const feedbackText = isCorrect ? question.feedback_correct : question.feedback_incorrect;
            
            questionResults[currentQuestionIndex] = {
                question: question.question,
                userAnswer: userAnswers[currentQuestionIndex],
                correctAnswer: question.correct_answer,
                isCorrect: isCorrect,
                theme: question.theme
            };
            
            feedbackArea.innerHTML = `
                <div class="feedback ${feedbackClass}">
                    <h4>${feedbackTitle}</h4>
                    <p>${feedbackText}</p>
                    ${!isCorrect ? `<p><strong>Bonne réponse:</strong> ${question.correct_answer}. ${question.feedback_correct}</p>` : ''}
                </div>
            `;
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishBtn');
            
            const hasAnswer = userAnswers[currentQuestionIndex] !== null;
            
            prevBtn.style.display = currentQuestionIndex > 0 ? 'block' : 'none';
            
            if (currentQuestionIndex === questions.length - 1) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = hasAnswer ? 'block' : 'none';
            } else {
                nextBtn.style.display = hasAnswer ? 'block' : 'none';
                finishBtn.style.display = 'none';
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function showResults() {
            // Calcul des résultats sur les questions réellement répondues
            let correctAnswers = 0;
            let answeredQuestions = 0;
            
            questionResults.forEach((result, index) => {
                // Ne compter que les questions qui ont été vues/répondues
                if (userAnswers[index] !== null || result) {
                    answeredQuestions++;
                    
                    if (correctionMode === 'final' && !result) {
                        const question = questions[index];
                        const userAnswer = userAnswers[index];
                        const isCorrect = userAnswer === question.correct_answer;
                        
                        questionResults[index] = {
                            question: question.question,
                            userAnswer: userAnswer,
                            correctAnswer: question.correct_answer,
                            isCorrect: isCorrect,
                            theme: question.theme
                        };
                    }
                    
                    if (questionResults[index] && questionResults[index].isCorrect) {
                        correctAnswers++;
                    }
                }
            });
            
            // Si aucune question répondue, utiliser le nombre total comme base
            if (answeredQuestions === 0) {
                answeredQuestions = questions.length;
            }
            
            const percentage = answeredQuestions > 0 ? Math.round((correctAnswers / answeredQuestions) * 100) : 0;
            
            // Affichage
            document.getElementById('quizPanel').classList.add('hidden');
            document.getElementById('resultsPanel').classList.remove('hidden');
            
            let grade = 'À améliorer';
            if (percentage >= 90) grade = 'Excellent';
            else if (percentage >= 80) grade = 'Très bien';
            else if (percentage >= 70) grade = 'Bien';
            else if (percentage >= 60) grade = 'Passable';
            
            // Message différent si arrêt en cours de route
            const isPartialQuiz = answeredQuestions < questions.length;
            const partialMessage = isPartialQuiz ? 
                `<p style="color: #ffc107; font-weight: 600; margin-bottom: 15px;">
                    📊 Session partielle : ${answeredQuestions} questions sur ${questions.length} disponibles
                </p>` : '';
            
            document.getElementById('resultsContent').innerHTML = `
                ${partialMessage}
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="display: inline-block; padding: 30px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border-radius: 20px; margin: 10px;">
                        <h3 style="font-size: 3em; margin-bottom: 10px;">${percentage}%</h3>
                        <p>Score${isPartialQuiz ? ' partiel' : ''}</p>
                    </div>
                    <div style="display: inline-block; padding: 30px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border-radius: 20px; margin: 10px;">
                        <h3 style="font-size: 2em; margin-bottom: 10px;">${grade}</h3>
                        <p>Appréciation</p>
                    </div>
                </div>
                <div style="text-align: center;">
                    <p style="font-size: 1.2em;">
                        <strong>${correctAnswers}</strong> bonnes réponses sur <strong>${answeredQuestions}</strong> questions répondues
                    </p>
                    ${isPartialQuiz ? 
                        `<p style="color: #6c757d; margin-top: 10px; font-size: 1em;">
                            💡 Pour continuer, redémarrez le questionnaire à la question ${answeredQuestions + 1}
                        </p>` : ''
                    }
                </div>
            `;
        }

        // Nouvelle fonction pour arrêter le quiz en cours
        function stopQuiz() {
            const answeredCount = userAnswers.filter(answer => answer !== null).length;
            
            if (answeredCount === 0) {
                if (confirm('Vous n\'avez répondu à aucune question. Voulez-vous vraiment arrêter ?')) {
                    restart();
                }
                return;
            }
            
            const currentQ = currentQuestionIndex + 1;
            if (confirm(`Arrêter le questionnaire maintenant ?\n\nVous avez répondu à ${answeredCount} questions sur ${currentQ} vues.\nVotre score sera calculé sur les questions répondues.`)) {
                showResults();
            }
        }

        function restart() {
            location.reload();
        }

        // Gestion des raccourcis clavier
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('quizPanel').classList.contains('hidden')) return;
            
            switch(event.key) {
                case 'ArrowLeft':
                    if (currentQuestionIndex > 0) previousQuestion();
                    break;
                case 'ArrowRight':
                    if (userAnswers[currentQuestionIndex] !== null) {
                        if (currentQuestionIndex < questions.length - 1) {
                            nextQuestion();
                        } else {
                            showResults();
                        }
                    }
                    break;
                case '1':
                case 'a':
                case 'A':
                    selectAnswer('A');
                    break;
                case '2':
                case 'b':
                case 'B':
                    selectAnswer('B');
                    break;
                case '3':
                case 'c':
                case 'C':
                    selectAnswer('C');
                    break;
                case '4':
                case 'd':
                case 'D':
                    selectAnswer('D');
                    break;
            }
        });

        function selectAnswer(value) {
            const option = document.getElementById(`option${value}`);
            if (option && !option.disabled) {
                option.checked = true;
                option.dispatchEvent(new Event('change'));
            }
        }

        // Test au chargement
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page chargée, script prêt!');
        });
    </script>
</body>
</html>
