<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionnaire OIIQ - Pr√©paration Examen</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .hidden { display: none; }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .option-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .info-box {
            background: #d4edda;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            border-left: 5px solid #28a745;
            color: #155724;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #dc3545;
            margin-bottom: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 30px;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .question-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .theme-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .question-box {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .question-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .answer-options {
            list-style: none;
            margin-bottom: 20px;
        }
        
        .answer-option {
            margin-bottom: 12px;
        }
        
        .answer-option input[type="radio"] {
            display: none;
        }
        
        .answer-option label {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .answer-option label:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .answer-option input[type="radio"]:checked + label {
            border-color: #667eea;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }
        
        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid;
        }
        
        .feedback.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .feedback.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header panel">
            <div style="text-align: center; margin-bottom: 20px;">
                <h1>üìã Questionnaire OIIQ</h1>
                <p style="font-size: 1.3em; color: #667eea; font-weight: 600;">Pr√©paration √† l'examen professionnel d'infirmi√®re</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 25px; border-radius: 15px; margin-top: 25px; border-left: 5px solid #667eea;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üéØ √Ä propos de ce questionnaire</h3>
                <p style="color: #495057; line-height: 1.7; margin-bottom: 15px;">
                    Cet outil interactif a √©t√© con√ßu pour vous aider √† pr√©parer efficacement l'examen professionnel de l'Ordre des infirmi√®res et infirmiers du Qu√©bec (OIIQ). 
                    Il vous permet de tester vos connaissances dans diff√©rents domaines des soins infirmiers √† travers des questions √† choix multiples.
                </p>
                
                <h4 style="color: #2c3e50; margin: 20px 0 10px 0;">üîß Comment utiliser ce questionnaire :</h4>
                <ul style="color: #495057; line-height: 1.6; margin-left: 20px;">
                    <li><strong>Chargement :</strong> Cliquez sur "Charger le questionnaire" pour lancer vos questions personnalis√©es</li>
                    <li><strong>Filtrage :</strong> S√©lectionnez un th√®me sp√©cifique ou gardez "Tous les th√®mes" pour un test complet</li>
                    <li><strong>Options :</strong> Choisissez entre correction instantan√©e (feedback imm√©diat) ou correction finale</li>
                    <li><strong>M√©lange :</strong> Activez le m√©lange des questions et/ou des r√©ponses pour un entra√Ænement plus vari√©</li>
                    <li><strong>Navigation :</strong> Utilisez les boutons ou les touches du clavier (fl√®ches, 1-4/A-D) pour naviguer</li>
                    <li><strong>R√©sultats :</strong> Obtenez un score d√©taill√© et une analyse par th√®me √† la fin</li>
                </ul>
                
                <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin-top: 20px;">
                    <p style="color: #0066cc; font-weight: 600; margin: 0;">
                        üí° <strong>Conseil :</strong> Pour une pr√©paration optimale, alternez entre les modes de correction instantan√©e (pour apprendre) 
                        et finale (pour simuler les conditions d'examen r√©elles).
                    </p>
                </div>
            </div>
        </div>

        <!-- Configuration -->
        <div id="setupPanel" class="panel">
            <h2>Configuration du questionnaire</h2>
            
            <div class="input-group">
                <label for="csvUrl">URL du fichier CSV</label>
                <input type="text" id="csvUrl" value="./Questions_Septembre_2025.csv">
            </div>
            
            <div class="info-box">
                <strong>‚úÖ Configuration GitHub Pages</strong><br>
                Le fichier CSV sera charg√© automatiquement depuis votre repository.<br>
                URL du site : <code>https://will400ex-cloud.github.io/OIIQ/</code><br>
                <small>Fichier attendu : <code>Questions_Septembre_2025.csv</code></small>
            </div>

            <div class="options-grid">
                <div class="option-card">
                    <h4>üéØ Mode de correction</h4>
                    <div class="checkbox-item">
                        <input type="radio" id="instantMode" name="correctionMode" value="instant" checked>
                        <label for="instantMode">Correction instantan√©e</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="radio" id="finalMode" name="correctionMode" value="final">
                        <label for="finalMode">Correction √† la fin</label>
                    </div>
                </div>

                <div class="option-card">
                    <h4>üîÄ Ordre des questions</h4>
                    <div class="checkbox-item">
                        <input type="checkbox" id="shuffleQuestions">
                        <label for="shuffleQuestions">M√©langer les questions</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="shuffleOptions">
                        <label for="shuffleOptions">M√©langer les r√©ponses</label>
                    </div>
                </div>
            </div>

            <div class="input-group">
                <label for="themeSelect">S√©lectionner un th√®me</label>
                <select id="themeSelect">
                    <option value="">Tous les th√®mes</option>
                </select>
            </div>

            <div style="text-align: center;">
                <button class="btn" onclick="initializeQuizFromSetup()">Charger le questionnaire</button>
            </div>
        </div>

        <!-- Quiz -->
        <div id="quizPanel" class="panel hidden">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>

            <div class="question-info">
                <span id="questionCounter">Question 1 sur 10</span>
                <span class="theme-badge" id="currentTheme">G√©n√©ral</span>
            </div>

            <div class="question-box">
                <div class="question-title" id="questionText"></div>
                <ul class="answer-options" id="answerOptions"></ul>
                <div id="feedbackArea"></div>
            </div>

            <div class="controls">
                <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()" style="display: none;">‚Üê Pr√©c√©dent</button>
                <button class="btn" id="nextBtn" onclick="nextQuestion()" style="display: none;">Suivant ‚Üí</button>
                <button class="btn" id="finishBtn" onclick="showResults()" style="display: none;">Terminer</button>
            </div>
        </div>

        <!-- R√©sultats -->
        <div id="resultsPanel" class="panel hidden">
            <h2 style="text-align: center; margin-bottom: 30px;">üéâ R√©sultats</h2>
            <div id="resultsContent"></div>
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="restart()">Recommencer</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let correctionMode = 'instant';
        let questionResults = [];

        // Donn√©es d'exemple (gard√©es pour r√©f√©rence mais non utilis√©es)
        const exampleQuestions = [];

        // Utilitaires
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let currentValue = '';
                let insideQuotes = false;
                
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim());
                
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index]?.replace(/"/g, '') || '';
                    });
                    data.push(row);
                }
            }
            return data;
        }

        function updateThemeSelect(themes) {
            const themeSelect = document.getElementById('themeSelect');
            if (themeSelect) {
                themeSelect.innerHTML = '<option value="">Tous les th√®mes</option>';
                themes.sort().forEach(theme => {
                    const option = document.createElement('option');
                    option.value = theme;
                    option.textContent = theme;
                    themeSelect.appendChild(option);
                });
                console.log('Th√®mes mis √† jour:', themes);
            }
        }

        // Fonction pour charger et initialiser depuis le setup
        function initializeQuizFromSetup() {
            loadQuestions();
        }

        // Chargement depuis CSV
        async function loadQuestions() {
            const csvUrl = document.getElementById('csvUrl').value.trim();
            
            if (!csvUrl) {
                alert('Veuillez saisir une URL');
                return;
            }

            try {
                document.getElementById('setupPanel').innerHTML = '<div class="loading">Chargement...</div>';
                
                console.log('Chargement depuis:', csvUrl);
                
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`Erreur ${response.status}: ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('CSV re√ßu, longueur:', csvText.length);
                
                const data = parseCSV(csvText);
                console.log('Donn√©es pars√©es:', data.length, 'lignes');
                
                if (data.length === 0) {
                    throw new Error('Aucune donn√©e trouv√©e');
                }

                // Traitement des donn√©es
                questions = data.map((row, index) => ({
                    id: row.id || (index + 1),
                    theme: row.theme || 'G√©n√©ral',
                    question: row.question,
                    option_a: row.option_a || '',
                    option_b: row.option_b || '',
                    option_c: row.option_c || '',
                    option_d: row.option_d || '',
                    correct_answer: row.correct_answer || 'A',
                    feedback_correct: row.feedback_correct || 'Bonne r√©ponse!',
                    feedback_incorrect: row.feedback_incorrect || 'R√©ponse incorrecte.'
                })).filter(q => q.question && q.question.trim());

                if (questions.length === 0) {
                    throw new Error('Aucune question valide trouv√©e');
                }

                // Mise √† jour des th√®mes
                const themes = [...new Set(questions.map(q => q.theme))];
                updateThemeSelect(themes);
                
                // Mettre √† jour l'interface pour indiquer le succ√®s
                document.getElementById('setupPanel').innerHTML = `
                    <h2>Configuration du questionnaire</h2>
                    
                    <div class="input-group">
                        <label for="csvUrl">URL du fichier CSV</label>
                        <input type="text" id="csvUrl" value="${csvUrl}">
                    </div>
                    
                    <div class="info-box">
                        <strong>‚úÖ Fichier CSV charg√© avec succ√®s!</strong><br>
                        ${questions.length} questions ont √©t√© charg√©es.<br>
                        Th√®mes disponibles : ${themes.join(', ')}<br>
                        Vous pouvez maintenant s√©lectionner vos options et lancer le questionnaire.
                    </div>

                    <div class="options-grid">
                        <div class="option-card">
                            <h4>üéØ Mode de correction</h4>
                            <div class="checkbox-item">
                                <input type="radio" id="instantMode" name="correctionMode" value="instant" checked>
                                <label for="instantMode">Correction instantan√©e</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="radio" id="finalMode" name="correctionMode" value="final">
                                <label for="finalMode">Correction √† la fin</label>
                            </div>
                        </div>

                        <div class="option-card">
                            <h4>üîÄ Ordre des questions</h4>
                            <div class="checkbox-item">
                                <input type="checkbox" id="shuffleQuestions">
                                <label for="shuffleQuestions">M√©langer les questions</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="shuffleOptions">
                                <label for="shuffleOptions">M√©langer les r√©ponses</label>
                            </div>
                        </div>
                    </div>

                    <div class="input-group">
                        <label for="themeSelect">S√©lectionner un th√®me</label>
                        <select id="themeSelect">
                            <option value="">Tous les th√®mes</option>
                        </select>
                    </div>

                    <div style="text-align: center;">
                        <button class="btn" onclick="initializeQuiz()">Lancer le questionnaire</button>
                        <button class="btn btn-secondary" onclick="location.reload()">Recharger un autre fichier</button>
                    </div>
                `;
                
                // Re-populer le s√©lecteur de th√®me
                updateThemeSelect(themes);
                
                console.log('Questions charg√©es:', questions.length);
                console.log('Th√®mes disponibles:', themes);
                
            } catch (error) {
                console.error('Erreur de chargement:', error);
                document.getElementById('setupPanel').innerHTML = `
                    <div class="error">
                        <h3>Erreur de chargement</h3>
                        <p>${error.message}</p>
                        <p>V√©rifiez que le fichier existe et est accessible.</p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="location.reload()">R√©essayer</button>
                    </div>
                `;
            }
        }

        function initializeQuiz() {
            // R√©cup√©ration des param√®tres
            correctionMode = document.querySelector('input[name="correctionMode"]:checked')?.value || 'instant';
            const selectedTheme = document.getElementById('themeSelect')?.value || '';
            
            // Filtrage par th√®me
            let filteredQuestions = questions;
            if (selectedTheme) {
                filteredQuestions = questions.filter(q => q.theme === selectedTheme);
            }
            
            // M√©lange des questions
            if (document.getElementById('shuffleQuestions')?.checked) {
                filteredQuestions = shuffleArray(filteredQuestions);
            }
            
            if (filteredQuestions.length === 0) {
                alert('Aucune question ne correspond aux crit√®res s√©lectionn√©s');
                return;
            }
            
            questions = filteredQuestions;
            userAnswers = new Array(questions.length).fill(null);
            questionResults = new Array(questions.length).fill(null);
            currentQuestionIndex = 0;
            
            showQuizPanel();
            displayQuestion();
        }

        function showQuizPanel() {
            document.getElementById('setupPanel').classList.add('hidden');
            document.getElementById('quizPanel').classList.remove('hidden');
        }

        function displayQuestion() {
            const question = questions[currentQuestionIndex];
            if (!question) return;
            
            // Mise √† jour des informations
            document.getElementById('questionCounter').textContent = 
                `Question ${currentQuestionIndex + 1} sur ${questions.length}`;
            document.getElementById('currentTheme').textContent = question.theme;
            
            // Barre de progression
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            
            // Question
            document.getElementById('questionText').textContent = question.question;
            
            // Options
            const optionsContainer = document.getElementById('answerOptions');
            optionsContainer.innerHTML = '';
            
            const options = [
                {value: 'A', text: question.option_a},
                {value: 'B', text: question.option_b},
                {value: 'C', text: question.option_c},
                {value: 'D', text: question.option_d}
            ];
            
            options.forEach(option => {
                if (option.text.trim()) {
                    const li = document.createElement('li');
                    li.className = 'answer-option';
                    li.innerHTML = `
                        <input type="radio" id="option${option.value}" name="answer" value="${option.value}">
                        <label for="option${option.value}">${option.value}. ${option.text}</label>
                    `;
                    optionsContainer.appendChild(li);
                }
            });
            
            // Restaurer r√©ponse pr√©c√©dente
            if (userAnswers[currentQuestionIndex]) {
                const prevAnswer = document.getElementById(`option${userAnswers[currentQuestionIndex]}`);
                if (prevAnswer) prevAnswer.checked = true;
            }
            
            // √âv√©nements
            document.querySelectorAll('input[name="answer"]').forEach(input => {
                input.addEventListener('change', function() {
                    userAnswers[currentQuestionIndex] = this.value;
                    
                    if (correctionMode === 'instant') {
                        showFeedback(this.value === question.correct_answer, question);
                    }
                    
                    updateButtons();
                });
            });
            
            // Reset feedback
            document.getElementById('feedbackArea').innerHTML = '';
            updateButtons();
        }

        function showFeedback(isCorrect, question) {
            const feedbackArea = document.getElementById('feedbackArea');
            const feedbackClass = isCorrect ? 'correct' : 'incorrect';
            const feedbackTitle = isCorrect ? '‚úÖ Correct!' : '‚ùå Incorrect';
            const feedbackText = isCorrect ? question.feedback_correct : question.feedback_incorrect;
            
            questionResults[currentQuestionIndex] = {
                question: question.question,
                userAnswer: userAnswers[currentQuestionIndex],
                correctAnswer: question.correct_answer,
                isCorrect: isCorrect,
                theme: question.theme
            };
            
            feedbackArea.innerHTML = `
                <div class="feedback ${feedbackClass}">
                    <h4>${feedbackTitle}</h4>
                    <p>${feedbackText}</p>
                    ${!isCorrect ? `<p><strong>Bonne r√©ponse:</strong> ${question.correct_answer}. ${question.feedback_correct}</p>` : ''}
                </div>
            `;
        }

        function updateButtons() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const finishBtn = document.getElementById('finishBtn');
            
            const hasAnswer = userAnswers[currentQuestionIndex] !== null;
            
            prevBtn.style.display = currentQuestionIndex > 0 ? 'block' : 'none';
            
            if (currentQuestionIndex === questions.length - 1) {
                nextBtn.style.display = 'none';
                finishBtn.style.display = hasAnswer ? 'block' : 'none';
            } else {
                nextBtn.style.display = hasAnswer ? 'block' : 'none';
                finishBtn.style.display = 'none';
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function showResults() {
            // Calcul des r√©sultats
            let correctAnswers = 0;
            
            questionResults.forEach((result, index) => {
                if (correctionMode === 'final' && !result) {
                    const question = questions[index];
                    const userAnswer = userAnswers[index];
                    const isCorrect = userAnswer === question.correct_answer;
                    
                    questionResults[index] = {
                        question: question.question,
                        userAnswer: userAnswer,
                        correctAnswer: question.correct_answer,
                        isCorrect: isCorrect,
                        theme: question.theme
                    };
                }
                
                if (questionResults[index].isCorrect) correctAnswers++;
            });
            
            const percentage = Math.round((correctAnswers / questions.length) * 100);
            
            // Affichage
            document.getElementById('quizPanel').classList.add('hidden');
            document.getElementById('resultsPanel').classList.remove('hidden');
            
            let grade = '√Ä am√©liorer';
            if (percentage >= 90) grade = 'Excellent';
            else if (percentage >= 80) grade = 'Tr√®s bien';
            else if (percentage >= 70) grade = 'Bien';
            else if (percentage >= 60) grade = 'Passable';
            
            document.getElementById('resultsContent').innerHTML = `
                <div style="text-align: center; margin-bottom: 30px;">
                    <div style="display: inline-block; padding: 30px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border-radius: 20px; margin: 10px;">
                        <h3 style="font-size: 3em; margin-bottom: 10px;">${percentage}%</h3>
                        <p>Score final</p>
                    </div>
                    <div style="display: inline-block; padding: 30px; background: linear-gradient(45deg, #667eea, #764ba2); color: white; border-radius: 20px; margin: 10px;">
                        <h3 style="font-size: 2em; margin-bottom: 10px;">${grade}</h3>
                        <p>Appr√©ciation</p>
                    </div>
                </div>
                <div style="text-align: center;">
                    <p style="font-size: 1.2em;"><strong>${correctAnswers}</strong> bonnes r√©ponses sur <strong>${questions.length}</strong> questions</p>
                </div>
            `;
        }

        function restart() {
            location.reload();
        }

        // Test au chargement
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page charg√©e, script pr√™t!');
        });
    </script>
</body>
</html>
