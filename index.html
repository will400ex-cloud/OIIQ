<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionnaire OIIQ - Pr√©paration Examen</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
        }
        
        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .setup-panel, .quiz-panel, .results-panel {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .hidden {
            display: none;
        }
        
        .csv-input {
            margin-bottom: 20px;
        }
        
        .csv-input label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .csv-input input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .csv-input input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .option-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            border: 2px solid #e9ecef;
            transition: all 0.3s;
        }
        
        .option-group:hover {
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .option-group h3 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .theme-selector {
            margin-bottom: 20px;
        }
        
        .theme-selector select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background: white;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #6c757d, #495057);
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            transition: width 0.3s ease;
            border-radius: 4px;
        }
        
        .question-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .question-counter {
            font-weight: 600;
            color: #495057;
        }
        
        .theme-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .scenario-box {
            background: #e8f4fd;
            border-left: 5px solid #007bff;
            padding: 20px;
            margin-bottom: 25px;
            border-radius: 10px;
        }
        
        .scenario-box h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .scenario-text {
            line-height: 1.6;
            color: #495057;
        }
        
        .question-box {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .question-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        .answer-options {
            list-style: none;
            margin-bottom: 20px;
        }
        
        .answer-option {
            margin-bottom: 12px;
        }
        
        .answer-option input[type="radio"] {
            display: none;
        }
        
        .answer-option label {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
            line-height: 1.4;
        }
        
        .answer-option label:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }
        
        .answer-option input[type="radio"]:checked + label {
            border-color: #667eea;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }
        
        .answer-option label::before {
            content: '';
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            margin-right: 15px;
            flex-shrink: 0;
            transition: all 0.3s;
        }
        
        .answer-option input[type="radio"]:checked + label::before {
            background: white;
            border-color: white;
            box-shadow: inset 0 0 0 4px #667eea;
        }
        
        .feedback {
            margin-top: 20px;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid;
            animation: slideIn 0.3s ease;
        }
        
        .feedback.correct {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .feedback.incorrect {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        
        .feedback h4 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .results-panel h2 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-size: 2.2em;
        }
        
        .score-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .score-item {
            text-align: center;
            padding: 25px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .score-item h3 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .score-item p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .results-by-theme {
            margin-bottom: 30px;
        }
        
        .theme-result {
            background: #f8f9fa;
            padding: 20px;
            margin-bottom: 15px;
            border-radius: 10px;
            border-left: 5px solid #667eea;
        }
        
        .theme-result h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .theme-progress {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .theme-progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #667eea, #764ba2);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
        
        .theme-progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 600;
            font-size: 14px;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 1.2em;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #dc3545;
            margin-bottom: 20px;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                justify-content: center;
            }
            
            .btn {
                padding: 12px 25px;
                font-size: 14px;
            }
            
            .score-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Questionnaire OIIQ</h1>
            <p>Pr√©paration √† l'examen professionnel d'infirmi√®re</p>
        </div>

        <!-- Panneau de configuration -->
        <div id="setupPanel" class="setup-panel">
            <h2>Configuration du questionnaire</h2>
            
            <div class="csv-input">
                <label for="csvUrl">URL du fichier CSV</label>
                <input type="text" id="csvUrl" placeholder="Ex: ./questions_quiz.csv" value="./questions_quiz.csv">
                
                <!-- Instructions -->
                <div style="background: #d4edda; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 5px solid #28a745;">
                    <h4 style="color: #155724; margin-bottom: 10px;">‚úÖ Configuration GitHub Pages</h4>
                    <p style="color: #155724; line-height: 1.6; margin: 0;">
                        Le fichier CSV est configur√© pour √™tre charg√© automatiquement depuis le m√™me repository.
                        <br><strong>URL de votre site :</strong> 
                        <code style="background: #f8f9fa; padding: 2px 5px; border-radius: 3px;">
                        https://will400ex-cloud.github.io/OIIQ/
                        </code>
                    </p>
                </div>
                
                <!-- Boutons -->
                <div style="margin-top: 15px;">
                    <button type="button" onclick="loadQuestions()" class="btn" style="margin-right: 10px;">Charger le questionnaire</button>
                    <button type="button" onclick="loadExampleCSV()" class="btn btn-secondary" style="padding: 8px 15px; font-size: 14px;">Exemple de test</button>
                </div>
                
                <!-- Zone de texte comme fallback -->
                <details style="margin-top: 20px;">
                    <summary style="cursor: pointer; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                        üíæ Fallback : Donn√©es CSV directes (cliquez pour ouvrir)
                    </summary>
                    <div style="margin-top: 10px;">
                        <textarea id="csvData" placeholder="Donn√©es CSV de secours..." 
                        style="width: 100%; height: 120px; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-family: monospace; font-size: 12px; resize: vertical;"></textarea>
                        <button type="button" onclick="loadFromTextArea()" class="btn" style="margin-top: 10px;">Charger depuis le texte</button>
                    </div>
                </details>
            </div>

            <div class="options">
                <div class="option-group">
                    <h3>üéØ Mode de correction</h3>
                    <div class="checkbox-group">
                        <input type="radio" id="instantMode" name="correctionMode" value="instant" checked>
                        <label for="instantMode">Correction instantan√©e</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="radio" id="finalMode" name="correctionMode" value="final">
                        <label for="finalMode">Correction √† la fin</label>
                    </div>
                </div>

                <div class="option-group">
                    <h3>üîÄ Ordre des questions</h3>
                    <div class="checkbox-group">
                        <input type="checkbox" id="shuffleQuestions">
                        <label for="shuffleQuestions">M√©langer les questions</label>
                    </div>
                    <div class="checkbox-group">
                        <input type="checkbox" id="shuffleOptions">
                        <label for="shuffleOptions">M√©langer les choix de r√©ponse</label>
                    </div>
                </div>
            </div>

            <div class="theme-selector">
                <label for="themeSelect">S√©lectionner un th√®me (optionnel - laissez "Tous" pour inclure toutes les questions)</label>
                <select id="themeSelect">
                    <option value="">Tous les th√®mes</option>
                </select>
            </div>

            <div style="text-align: center;">
                <button class="btn" onclick="loadQuestions()">Charger le questionnaire</button>
            </div>
        </div>

        <!-- Panneau du quiz -->
        <div id="quizPanel" class="quiz-panel hidden">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>

            <div class="question-info">
                <span class="question-counter" id="questionCounter">Question 1 sur 10</span>
                <span class="theme-badge" id="currentTheme">Soins g√©n√©raux</span>
            </div>

            <div id="scenarioBox" class="scenario-box hidden">
                <h3>Mise en situation</h3>
                <div class="scenario-text" id="scenarioText"></div>
            </div>

            <div class="question-box">
                <div class="question-title" id="questionText"></div>
                <ul class="answer-options" id="answerOptions"></ul>
                <div id="feedbackArea"></div>
            </div>

            <div class="controls">
                <button class="btn btn-secondary" id="prevBtn" onclick="previousQuestion()">‚Üê Pr√©c√©dent</button>
                <button class="btn" id="nextBtn" onclick="nextQuestion()">Suivant ‚Üí</button>
                <button class="btn" id="finishBtn" onclick="showResults()" style="display: none;">Terminer</button>
            </div>
        </div>

        <!-- Panneau des r√©sultats -->
        <div id="resultsPanel" class="results-panel hidden">
            <h2>üéâ R√©sultats du questionnaire</h2>
            
            <div class="score-summary" id="scoreSummary"></div>
            
            <div class="results-by-theme" id="resultsByTheme"></div>
            
            <div style="text-align: center;">
                <button class="btn" onclick="restartQuiz()">Recommencer</button>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let correctionMode = 'instant';
        let currentScenario = null;
        let questionResults = [];
        
        // Fonctions utilitaires
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const values = [];
                let currentValue = '';
                let insideQuotes = false;
                
                for (let j = 0; j < lines[i].length; j++) {
                    const char = lines[i][j];
                    if (char === '"') {
                        insideQuotes = !insideQuotes;
                    } else if (char === ',' && !insideQuotes) {
                        values.push(currentValue.trim());
                        currentValue = '';
                    } else {
                        currentValue += char;
                    }
                }
                values.push(currentValue.trim());
                
                if (values.length === headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index]?.replace(/"/g, '') || '';
                    });
                    data.push(row);
                }
            }
            
            return data;
        }

        // Fonction pour tester GitHub Pages
        function tryGithubPages() {
            const githubPagesUrl = 'https://will400ex-cloud.github.io/OIIQ/questions_quiz.csv';
            document.getElementById('csvUrl').value = githubPagesUrl;
            
            // Tenter de charger directement
            loadQuestions();
        }

        // Fonction pour charger depuis la zone de texte
        function loadFromTextArea() {
            const csvData = document.getElementById('csvData').value.trim();
            if (!csvData) {
                alert('Veuillez coller vos donn√©es CSV dans la zone de texte');
                return;
            }

            try {
                document.getElementById('setupPanel').innerHTML = '<div class="loading">Traitement des donn√©es CSV...</div>';
                
                const parsedData = parseCSV(csvData);
                if (parsedData.length === 0) {
                    throw new Error('Aucune question trouv√©e dans les donn√©es CSV');
                }

                // Traitement des donn√©es
                questions = processParsedData(parsedData);
                
                // R√©cup√©ration des param√®tres
                correctionMode = document.querySelector('input[name="correctionMode"]:checked').value;
                const selectedTheme = document.getElementById('themeSelect').value;
                
                // Filtrage par th√®me
                if (selectedTheme) {
                    questions = questions.filter(q => q.theme === selectedTheme);
                }
                
                // M√©lange des questions
                if (document.getElementById('shuffleQuestions').checked) {
                    questions = shuffleArray(questions);
                }
                
                // M√©lange des options de r√©ponse
                if (document.getElementById('shuffleOptions').checked) {
                    questions.forEach(question => {
                        const options = [
                            {letter: 'A', text: question.option_a},
                            {letter: 'B', text: question.option_b},
                            {letter: 'C', text: question.option_c},
                            {letter: 'D', text: question.option_d}
                        ];
                        
                        const correctOption = options.find(opt => opt.letter === question.correct_answer);
                        const shuffledOptions = shuffleArray(options);
                        
                        question.option_a = shuffledOptions[0].text;
                        question.option_b = shuffledOptions[1].text;
                        question.option_c = shuffledOptions[2].text;
                        question.option_d = shuffledOptions[3].text;
                        
                        question.correct_answer = ['A', 'B', 'C', 'D'][shuffledOptions.findIndex(opt => opt === correctOption)];
                    });
                }
                
                if (questions.length === 0) {
                    throw new Error('Aucune question ne correspond au th√®me s√©lectionn√©');
                }
                
                // Initialisation du quiz
                userAnswers = new Array(questions.length).fill(null);
                questionResults = new Array(questions.length).fill(null);
                currentQuestionIndex = 0;
                
                showQuizPanel();
                displayQuestion();
                
            } catch (error) {
                document.getElementById('setupPanel').innerHTML = `
                    <div class="error">
                        <h3>Erreur de traitement</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px;"><small>V√©rifiez que vos donn√©es CSV sont au bon format avec les bonnes colonnes.</small></p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="location.reload()">R√©essayer</button>
                    </div>
                `;
                console.error('Erreur:', error);
            }
        }

        // Fonction pour charger l'exemple CSV
        function loadExampleCSV() {
            const exampleData = `id,theme,scenario_id,scenario_text,question_number,question,option_a,option_b,option_c,option_d,correct_answer,feedback_correct,feedback_incorrect
1,Pharmacologie,,,1,"Quelle est la voie d'administration la plus rapide pour un m√©dicament en situation d'urgence?",Orale,Intraveineuse,Intramusculaire,Sous-cutan√©e,B,"Correct! La voie intraveineuse permet une absorption imm√©diate du m√©dicament directement dans la circulation sanguine.","La voie intraveineuse est la plus rapide car le m√©dicament est directement inject√© dans la circulation sanguine, contrairement aux autres voies qui n√©cessitent une absorption."
2,Pharmacologie,,,1,"Avant d'administrer de la digoxine, l'infirmi√®re doit obligatoirement v√©rifier:",La pression art√©rielle,Le pouls apical,La temp√©rature,La glyc√©mie,B,"Excellent! Il faut toujours v√©rifier le pouls apical avant d'administrer de la digoxine car ce m√©dicament peut causer une bradycardie dangereuse.","Il est essentiel de v√©rifier le pouls apical avant l'administration de digoxine car ce m√©dicament peut ralentir dangereusement le rythme cardiaque."
3,Soins critiques,SC001,"Mme Dubois, 65 ans, est hospitalis√©e aux soins intensifs suite √† un infarctus du myocarde. Elle pr√©sente une pression art√©rielle de 80/50 mmHg, un pouls de 110 bpm et des signes de d√©tresse respiratoire.",1,"Quelle est la priorit√© imm√©diate dans les soins √† Mme Dubois?",Administrer un analg√©sique,Surveiller la diur√®se,Am√©liorer la perfusion tissulaire,Prendre les signes vitaux,C,"Correct! Avec une PA basse et une tachycardie, la priorit√© est d'am√©liorer la perfusion tissulaire pour √©viter le choc cardiog√©nique.","Avec une hypotension et une tachycardie post-infarctus, la priorit√© est d'am√©liorer la perfusion tissulaire pour pr√©venir le choc cardiog√©nique."
4,Soins critiques,SC001,"Mme Dubois, 65 ans, est hospitalis√©e aux soins intensifs suite √† un infarctus du myocarde. Elle pr√©sente une pression art√©rielle de 80/50 mmHg, un pouls de 110 bpm et des signes de d√©tresse respiratoire.",2,"Quel signe indique une complication grave chez Mme Dubois?",Douleur thoracique l√©g√®re,≈íd√®me pulmonaire,Naus√©es,Fatigue,B,"Excellent! L'≈ìd√®me pulmonaire est une complication grave de l'infarctus qui n√©cessite une intervention imm√©diate.","L'≈ìd√®me pulmonaire est une complication majeure de l'infarctus du myocarde qui peut mettre la vie en danger et n√©cessite des soins imm√©diats."
5,√âthique et d√©ontologie,,,1,"Un patient conscient refuse un traitement recommand√© par le m√©decin. L'infirmi√®re doit:",Convaincre le patient d'accepter,Respecter la d√©cision du patient,Appeler la famille,Ignorer le refus,B,"Correct! Le principe d'autonomie du patient doit √™tre respect√©, m√™me si l'infirmi√®re n'est pas d'accord avec la d√©cision.","Le respect de l'autonomie du patient est un principe fondamental en soins infirmiers. Un patient conscient a le droit de refuser un traitement."
6,P√©diatrie,,,1,"Chez un nourrisson de 6 mois, quel est le signe le plus pr√©occupant de d√©shydratation?",Pleurs sans larmes,Bouche s√®che,Fontanelle d√©prim√©e,Somnolence excessive,C,"Correct! La fontanelle d√©prim√©e chez un nourrisson est un signe tardif mais tr√®s sp√©cifique de d√©shydratation s√©v√®re.","La fontanelle d√©prim√©e est un signe clinique important de d√©shydratation chez le nourrisson car elle indique une perte significative de volume liquidien."`;

            // Simuler le chargement avec les donn√©es d'exemple
            try {
                const parsedData = parseCSV(exampleData);
                questions = processParsedData(parsedData);
                
                // R√©cup√©ration des param√®tres
                correctionMode = document.querySelector('input[name="correctionMode"]:checked').value;
                const selectedTheme = document.getElementById('themeSelect').value;
                
                // Filtrage par th√®me
                if (selectedTheme) {
                    questions = questions.filter(q => q.theme === selectedTheme);
                }
                
                // M√©lange des questions
                if (document.getElementById('shuffleQuestions').checked) {
                    questions = shuffleArray(questions);
                }
                
                // M√©lange des options de r√©ponse
                if (document.getElementById('shuffleOptions').checked) {
                    questions.forEach(question => {
                        const options = [
                            {letter: 'A', text: question.option_a},
                            {letter: 'B', text: question.option_b},
                            {letter: 'C', text: question.option_c},
                            {letter: 'D', text: question.option_d}
                        ];
                        
                        const correctOption = options.find(opt => opt.letter === question.correct_answer);
                        const shuffledOptions = shuffleArray(options);
                        
                        question.option_a = shuffledOptions[0].text;
                        question.option_b = shuffledOptions[1].text;
                        question.option_c = shuffledOptions[2].text;
                        question.option_d = shuffledOptions[3].text;
                        
                        question.correct_answer = ['A', 'B', 'C', 'D'][shuffledOptions.findIndex(opt => opt === correctOption)];
                    });
                }
                
                // Initialisation du quiz
                userAnswers = new Array(questions.length).fill(null);
                questionResults = new Array(questions.length).fill(null);
                currentQuestionIndex = 0;
                
                showQuizPanel();
                displayQuestion();
                
            } catch (error) {
                alert('Erreur lors du chargement de l\'exemple: ' + error.message);
            }
        }

        // Chargement des questions
        async function loadQuestions() {
            const csvUrl = document.getElementById('csvUrl').value.trim();
            if (!csvUrl) {
                alert('Veuillez saisir l\'URL du fichier CSV');
                return;
            }

            try {
                document.getElementById('setupPanel').innerHTML = '<div class="loading">Chargement des questions...</div>';
                
                // Conversion de l'URL Google Drive si n√©cessaire
                let processedUrl = csvUrl;
                
                if (csvUrl.includes('drive.google.com/file/d/')) {
                    const fileId = csvUrl.match(/\/file\/d\/([a-zA-Z0-9-_]+)/)?.[1];
                    if (fileId) {
                        // Plusieurs formats √† essayer pour Google Drive
                        const urls = [
                            `https://drive.google.com/uc?export=download&id=${fileId}`,
                            `https://docs.google.com/uc?export=download&id=${fileId}`,
                            `https://drive.google.com/uc?id=${fileId}&export=download`,
                            `https://drive.usercontent.google.com/download?id=${fileId}&export=download`
                        ];
                        processedUrl = urls[0]; // Commencer par le premier
                    }
                } else if (csvUrl.includes('docs.google.com/spreadsheets')) {
                    // Pour les URLs Google Sheets d√©j√† au bon format
                    if (csvUrl.includes('pub?output=csv') || csvUrl.includes('export?format=csv')) {
                        processedUrl = csvUrl; // D√©j√† au bon format
                    } else if (!csvUrl.includes('export?format=csv')) {
                        const sheetId = csvUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/)?.[1];
                        const gid = csvUrl.match(/gid=([0-9]+)/)?.[1] || '0';
                        processedUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                    }
                }

                // Tentative de r√©cup√©ration avec gestion d'erreur am√©lior√©e et proxy CORS
                let response;
                try {
                    // Essai direct d'abord
                    response = await fetch(processedUrl, {
                        method: 'GET',
                        mode: 'cors'
                    });
                } catch (fetchError) {
                    // Si CORS √©choue, essayer avec un proxy CORS public
                    try {
                        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(processedUrl)}`;
                        const proxyResponse = await fetch(proxyUrl);
                        if (proxyResponse.ok) {
                            const proxyData = await proxyResponse.json();
                            const csvText = proxyData.contents;
                            
                            // Traitement direct des donn√©es du proxy
                            const parsedData = parseCSV(csvText);
                            if (parsedData.length === 0) {
                                throw new Error('Aucune question trouv√©e dans le fichier CSV');
                            }
                            questions = processParsedData(parsedData);
                            
                            // Continuer avec le traitement normal
                            correctionMode = document.querySelector('input[name="correctionMode"]:checked').value;
                            const selectedTheme = document.getElementById('themeSelect').value;
                            
                            if (selectedTheme) {
                                questions = questions.filter(q => q.theme === selectedTheme);
                            }
                            
                            if (document.getElementById('shuffleQuestions').checked) {
                                questions = shuffleArray(questions);
                            }
                            
                            if (document.getElementById('shuffleOptions').checked) {
                                questions.forEach(question => {
                                    const options = [
                                        {letter: 'A', text: question.option_a},
                                        {letter: 'B', text: question.option_b},
                                        {letter: 'C', text: question.option_c},
                                        {letter: 'D', text: question.option_d}
                                    ];
                                    
                                    const correctOption = options.find(opt => opt.letter === question.correct_answer);
                                    const shuffledOptions = shuffleArray(options);
                                    
                                    question.option_a = shuffledOptions[0].text;
                                    question.option_b = shuffledOptions[1].text;
                                    question.option_c = shuffledOptions[2].text;
                                    question.option_d = shuffledOptions[3].text;
                                    
                                    question.correct_answer = ['A', 'B', 'C', 'D'][shuffledOptions.findIndex(opt => opt === correctOption)];
                                });
                            }
                            
                            if (questions.length === 0) {
                                throw new Error('Aucune question ne correspond au th√®me s√©lectionn√©');
                            }
                            
                            userAnswers = new Array(questions.length).fill(null);
                            questionResults = new Array(questions.length).fill(null);
                            currentQuestionIndex = 0;
                            
                            showQuizPanel();
                            displayQuestion();
                            return; // Sortir de la fonction si le proxy a fonctionn√©
                        }
                    } catch (proxyError) {
                        throw new Error(`Impossible d'acc√©der au fichier via URL. Erreur: ${fetchError.message}. Essayez de copier-coller directement le contenu CSV dans la zone de texte.`);
                    }
                }
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const csvText = await response.text();
                const parsedData = parseCSV(csvText);
                
                if (parsedData.length === 0) {
                    throw new Error('Aucune question trouv√©e dans le fichier CSV');
                }

                // Traitement des donn√©es
                questions = processParsedData(parsedData);
                
                // R√©cup√©ration des param√®tres
                correctionMode = document.querySelector('input[name="correctionMode"]:checked').value;
                const selectedTheme = document.getElementById('themeSelect').value;
                
                // Filtrage par th√®me
                if (selectedTheme) {
                    questions = questions.filter(q => q.theme === selectedTheme);
                }
                
                // M√©lange des questions
                if (document.getElementById('shuffleQuestions').checked) {
                    questions = shuffleArray(questions);
                }
                
                // M√©lange des options de r√©ponse
                if (document.getElementById('shuffleOptions').checked) {
                    questions.forEach(question => {
                        const options = [
                            {letter: 'A', text: question.option_a},
                            {letter: 'B', text: question.option_b},
                            {letter: 'C', text: question.option_c},
                            {letter: 'D', text: question.option_d}
                        ];
                        
                        const correctOption = options.find(opt => opt.letter === question.correct_answer);
                        const shuffledOptions = shuffleArray(options);
                        
                        question.option_a = shuffledOptions[0].text;
                        question.option_b = shuffledOptions[1].text;
                        question.option_c = shuffledOptions[2].text;
                        question.option_d = shuffledOptions[3].text;
                        
                        question.correct_answer = ['A', 'B', 'C', 'D'][shuffledOptions.findIndex(opt => opt === correctOption)];
                    });
                }
                
                if (questions.length === 0) {
                    throw new Error('Aucune question ne correspond au th√®me s√©lectionn√©');
                }
                
                // Initialisation du quiz
                userAnswers = new Array(questions.length).fill(null);
                questionResults = new Array(questions.length).fill(null);
                currentQuestionIndex = 0;
                
                showQuizPanel();
                displayQuestion();
                
            } catch (error) {
                document.getElementById('setupPanel').innerHTML = `
                    <div class="error">
                        <h3>Erreur de chargement</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px;"><small>V√©rifiez que l'URL est correcte et que le fichier est accessible publiquement.</small></p>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn" onclick="location.reload()">R√©essayer</button>
                    </div>
                `;
                console.error('Erreur:', error);
            }
        }

        function processParsedData(data) {
            const processedQuestions = [];
            const themes = new Set();
            
            data.forEach(row => {
                if (row.question && row.question.trim()) {
                    processedQuestions.push({
                        id: row.id || processedQuestions.length + 1,
                        theme: row.theme || 'Non cat√©goris√©',
                        scenario_id: row.scenario_id || null,
                        scenario_text: row.scenario_text || '',
                        question_number: row.question_number || 1,
                        question: row.question,
                        option_a: row.option_a || '',
                        option_b: row.option_b || '',
                        option_c: row.option_c || '',
                        option_d: row.option_d || '',
                        correct_answer: row.correct_answer || 'A',
                        feedback_correct: row.feedback_correct || 'Bonne r√©ponse !',
                        feedback_incorrect: row.feedback_incorrect || 'R√©ponse incorrecte.'
                    });
                    themes.add(row.theme || 'Non cat√©goris√©');
                }
            });
            
            // Mise √† jour de la liste des th√®mes avec v√©rification de s√©curit√©
            const themeSelect = safeGetElement('themeSelect');
            if (themeSelect) {
                themeSelect.innerHTML = '<option value="">Tous les th√®mes</option>';
                Array.from(themes).sort().forEach(theme => {
                    const option = document.createElement('option');
                    option.value = theme;
                    option.textContent = theme;
                    themeSelect.appendChild(option);
                });
                console.log('Th√®mes charg√©s:', Array.from(themes));
            } else {
                console.warn('√âl√©ment themeSelect non trouv√©, mais continuons...');
            }
            
            return processedQuestions;
        }

        function showQuizPanel() {
            const setupPanel = safeGetElement('setupPanel');
            const quizPanel = safeGetElement('quizPanel');
            
            if (setupPanel) {
                setupPanel.classList.add('hidden');
            }
            if (quizPanel) {
                quizPanel.classList.remove('hidden');
            }
        }

        function displayQuestion() {
            const question = questions[currentQuestionIndex];
            if (!question) return;
            
            // Mise √† jour du compteur et th√®me avec v√©rifications
            const questionCounter = safeGetElement('questionCounter');
            if (questionCounter) {
                questionCounter.textContent = `Question ${currentQuestionIndex + 1} sur ${questions.length}`;
            }
            
            const currentTheme = safeGetElement('currentTheme');
            if (currentTheme) {
                currentTheme.textContent = question.theme;
            }
            
            // Mise √† jour de la barre de progression
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            const progressFill = safeGetElement('progressFill');
            if (progressFill) {
                progressFill.style.width = progress + '%';
            }
            
            // Gestion des sc√©narios
            const scenarioBox = safeGetElement('scenarioBox');
            const scenarioText = safeGetElement('scenarioText');
            
            if (question.scenario_id && question.scenario_text && currentScenario !== question.scenario_id) {
                currentScenario = question.scenario_id;
                if (scenarioBox) scenarioBox.classList.remove('hidden');
                if (scenarioText) scenarioText.textContent = question.scenario_text;
            } else if (!question.scenario_id || !question.scenario_text) {
                if (scenarioBox) scenarioBox.classList.add('hidden');
                currentScenario = null;
            }
            
            // Affichage de la question
            const questionTextElement = safeGetElement('questionText');
            if (questionTextElement) {
                questionTextElement.textContent = question.question;
            }
            
            // Options de r√©ponse
            const optionsContainer = safeGetElement('answerOptions');
            if (!optionsContainer) return;
            
            optionsContainer.innerHTML = '';
            
            const options = [
                {value: 'A', text: question.option_a},
                {value: 'B', text: question.option_b},
                {value: 'C', text: question.option_c},
                {value: 'D', text: question.option_d}
            ];
            
            options.forEach(option => {
                if (option.text.trim()) {
                    const li = document.createElement('li');
                    li.className = 'answer-option';
                    li.innerHTML = `
                        <input type="radio" id="option${option.value}" name="answer" value="${option.value}">
                        <label for="option${option.value}">${option.value}. ${option.text}</label>
                    `;
                    optionsContainer.appendChild(li);
                }
            });
            
            // Restaurer la r√©ponse pr√©c√©dente si elle existe
            if (userAnswers[currentQuestionIndex]) {
                const previousAnswer = document.getElementById(`option${userAnswers[currentQuestionIndex]}`);
                if (previousAnswer) previousAnswer.checked = true;
            }
            
            // Gestion des √©v√©nements de s√©lection
            document.querySelectorAll('input[name="answer"]').forEach(input => {
                input.addEventListener('change', function() {
                    userAnswers[currentQuestionIndex] = this.value;
                    
                    if (correctionMode === 'instant') {
                        showFeedback(this.value === question.correct_answer, question);
                    }
                    
                    // Activer le bouton suivant/terminer
                    updateNavigationButtons();
                });
            });
            
            // R√©initialiser la zone de feedback
            const feedbackArea = safeGetElement('feedbackArea');
            if (feedbackArea) {
                feedbackArea.innerHTML = '';
            }
            
            // Mise √† jour des boutons de navigation
            updateNavigationButtons();
        }

        function showFeedback(isCorrect, question) {
            const feedbackArea = safeGetElement('feedbackArea');
            if (!feedbackArea) return;
            
            const feedbackClass = isCorrect ? 'correct' : 'incorrect';
            const feedbackTitle = isCorrect ? '‚úÖ Correct !' : '‚ùå Incorrect';
            const feedbackText = isCorrect ? question.feedback_correct : question.feedback_incorrect;
            
            // Enregistrer le r√©sultat
            questionResults[currentQuestionIndex] = {
                question: question.question,
                userAnswer: userAnswers[currentQuestionIndex],
                correctAnswer: question.correct_answer,
                isCorrect: isCorrect,
                theme: question.theme
            };
            
            feedbackArea.innerHTML = `
                <div class="feedback ${feedbackClass}">
                    <h4>${feedbackTitle}</h4>
                    <p>${feedbackText}</p>
                    ${!isCorrect ? `<p><strong>Bonne r√©ponse :</strong> ${question.correct_answer}. ${question.feedback_correct}</p>` : ''}
                </div>
            `;
        }

        function updateNavigationButtons() {
            const prevBtn = safeGetElement('prevBtn');
            const nextBtn = safeGetElement('nextBtn');
            const finishBtn = safeGetElement('finishBtn');
            
            // Bouton pr√©c√©dent
            if (prevBtn) {
                prevBtn.style.display = currentQuestionIndex > 0 ? 'block' : 'none';
            }
            
            // Bouton suivant/terminer
            const hasAnswer = userAnswers[currentQuestionIndex] !== null;
            
            if (currentQuestionIndex === questions.length - 1) {
                if (nextBtn) nextBtn.style.display = 'none';
                if (finishBtn) finishBtn.style.display = hasAnswer ? 'block' : 'none';
            } else {
                if (nextBtn) nextBtn.style.display = hasAnswer ? 'block' : 'none';
                if (finishBtn) finishBtn.style.display = 'none';
            }
        }

        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function showResults() {
            // Calcul des r√©sultats
            let correctAnswers = 0;
            let totalQuestions = questions.length;
            const themeResults = {};
            
            questionResults.forEach((result, index) => {
                if (correctionMode === 'final' && !result) {
                    // Traitement des r√©sultats pour mode final
                    const question = questions[index];
                    const userAnswer = userAnswers[index];
                    const isCorrect = userAnswer === question.correct_answer;
                    
                    questionResults[index] = {
                        question: question.question,
                        userAnswer: userAnswer,
                        correctAnswer: question.correct_answer,
                        isCorrect: isCorrect,
                        theme: question.theme
                    };
                }
                
                const finalResult = questionResults[index];
                if (finalResult.isCorrect) correctAnswers++;
                
                // Statistiques par th√®me
                if (!themeResults[finalResult.theme]) {
                    themeResults[finalResult.theme] = { correct: 0, total: 0 };
                }
                themeResults[finalResult.theme].total++;
                if (finalResult.isCorrect) {
                    themeResults[finalResult.theme].correct++;
                }
            });
            
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            
            // Affichage des r√©sultats
            document.getElementById('quizPanel').classList.add('hidden');
            document.getElementById('resultsPanel').classList.remove('hidden');
            
            // R√©sum√© des scores
            const scoreSummary = document.getElementById('scoreSummary');
            scoreSummary.innerHTML = `
                <div class="score-item">
                    <h3>${correctAnswers}</h3>
                    <p>Bonnes r√©ponses</p>
                </div>
                <div class="score-item">
                    <h3>${totalQuestions - correctAnswers}</h3>
                    <p>Erreurs</p>
                </div>
                <div class="score-item">
                    <h3>${percentage}%</h3>
                    <p>Score final</p>
                </div>
                <div class="score-item">
                    <h3>${getGrade(percentage)}</h3>
                    <p>Appr√©ciation</p>
                </div>
            `;
            
            // R√©sultats par th√®me
            const resultsByTheme = document.getElementById('resultsByTheme');
            let themeHTML = '<h3>R√©sultats d√©taill√©s par th√®me</h3>';
            
            Object.keys(themeResults).sort().forEach(theme => {
                const result = themeResults[theme];
                const themePercentage = Math.round((result.correct / result.total) * 100);
                
                themeHTML += `
                    <div class="theme-result">
                        <h4>${theme}</h4>
                        <p>${result.correct}/${result.total} questions correctes</p>
                        <div class="theme-progress">
                            <div class="theme-progress-fill" style="width: ${themePercentage}%"></div>
                            <div class="theme-progress-text">${themePercentage}%</div>
                        </div>
                    </div>
                `;
            });
            
            // R√©vision des erreurs
            const incorrectQuestions = questionResults.filter(result => !result.isCorrect);
            if (incorrectQuestions.length > 0) {
                themeHTML += `
                    <div style="margin-top: 30px;">
                        <h3>Questions √† r√©viser</h3>
                        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 5px solid #ffc107;">
                `;
                
                incorrectQuestions.forEach((result, index) => {
                    themeHTML += `
                        <div style="margin-bottom: 15px; padding-bottom: 15px; ${index < incorrectQuestions.length - 1 ? 'border-bottom: 1px solid #dee2e6;' : ''}">
                            <p><strong>Question :</strong> ${result.question}</p>
                            <p><strong>Votre r√©ponse :</strong> ${result.userAnswer || 'Non r√©pondu'}</p>
                            <p><strong>Bonne r√©ponse :</strong> ${result.correctAnswer}</p>
                            <p><strong>Th√®me :</strong> ${result.theme}</p>
                        </div>
                    `;
                });
                
                themeHTML += '</div></div>';
            }
            
            resultsByTheme.innerHTML = themeHTML;
        }

        function getGrade(percentage) {
            if (percentage >= 90) return 'Excellent';
            if (percentage >= 80) return 'Tr√®s bien';
            if (percentage >= 70) return 'Bien';
            if (percentage >= 60) return 'Passable';
            return '√Ä am√©liorer';
        }

        function restartQuiz() {
            // R√©initialisation des variables
            currentQuestionIndex = 0;
            userAnswers = [];
            questionResults = [];
            currentScenario = null;
            
            // Affichage du panneau de configuration
            document.getElementById('resultsPanel').classList.add('hidden');
            document.getElementById('setupPanel').classList.remove('hidden');
            
            // R√©initialisation du contenu du panneau de configuration
            location.reload();
        }

        // Gestion des raccourcis clavier
        document.addEventListener('keydown', function(event) {
            if (document.getElementById('quizPanel').classList.contains('hidden')) return;
            
            switch(event.key) {
                case 'ArrowLeft':
                    if (currentQuestionIndex > 0) previousQuestion();
                    break;
                case 'ArrowRight':
                    if (userAnswers[currentQuestionIndex] !== null) {
                        if (currentQuestionIndex < questions.length - 1) {
                            nextQuestion();
                        } else {
                            showResults();
                        }
                    }
                    break;
                case '1':
                case 'a':
                case 'A':
                    selectAnswer('A');
                    break;
                case '2':
                case 'b':
                case 'B':
                    selectAnswer('B');
                    break;
                case '3':
                case 'c':
                case 'C':
                    selectAnswer('C');
                    break;
                case '4':
                case 'd':
                case 'D':
                    selectAnswer('D');
                    break;
            }
        });

        function selectAnswer(value) {
            const option = document.getElementById(`option${value}`);
            if (option) {
                option.checked = true;
                option.dispatchEvent(new Event('change'));
            }
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Message d'aide pour Google Drive
            const helpText = document.createElement('div');
            helpText.style.cssText = 'background: #e7f3ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 5px solid #007bff;';
            helpText.innerHTML = `
                <h4 style="color: #007bff; margin-bottom: 10px;">üí° Comment obtenir l'URL du fichier CSV ?</h4>
                <div style="color: #495057; line-height: 1.6;">
                    <p><strong>H√©bergement recommand√© pour vos fichiers CSV :</strong></p>
                    <ol style="margin-left: 20px;">
                        <li><strong>GitHub (recommand√©) :</strong> Cr√©ez un repository ‚Üí uploadez votre CSV ‚Üí Raw URL</li>
                        <li><strong>GitHub Gist :</strong> gist.github.com ‚Üí collez votre CSV ‚Üí Raw URL</li>
                        <li><strong>Pastebin :</strong> pastebin.com ‚Üí Public + Never expire ‚Üí Raw URL</li>
                    </ol>
                    <p><strong>Format d'URL attendu :</strong><br>
                    <code style="background: #f8f9fa; padding: 2px 5px; border-radius: 3px; font-size: 0.9em;">
                    https://raw.githubusercontent.com/user/repo/main/questions.csv
                    </code></p>
                    <p><strong>Alternative :</strong> Collez directement vos donn√©es CSV dans la zone de texte ci-dessus !</p>
                </div>
            `;
            
            const csvInputDiv = document.querySelector('.csv-input');
            csvInputDiv.insertBefore(helpText, csvInputDiv.children[1]);
        });
    </script>
</body>
</html>
